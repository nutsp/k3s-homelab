# Global settings
global:
  namespace: app

# Centralized Ingress configuration
ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/rule-type: PathPrefix
  middlewares: []
  tls:
    enabled: false
  hosts:
    - host: auth.local
      paths:
        - path: /
          pathType: Prefix
          backend:
            serviceName: auth-service
            servicePort: 80
    - host: profile.local
      paths:
        - path: /
          pathType: Prefix
          backend:
            serviceName: profile-service
            servicePort: 80

auth:
  enabled: true
  namespace: app
  replicas: 1
  image:
    repository: nginx
    tag: 1.29-alpine3.23  # Recommended: Use specific version tag (e.g., v1.2.3)
    pullPolicy: Always  # Use Always when using latest tag
  service:
    name: auth-service
  configmaps:
    virtual_server_enabled: "true"
  secrets:
    db_user: admin
    db_password: password
    db_host: localhost
    db_port: "5432"
    db_name: auth_db
  healthCheck:
    enabled: false 
  securityContext:
    enabled: false

profile:
  enabled: true
  namespace: app
  replicas: 1
  image:
    repository: nginx
    tag: latest  # Recommended: Use specific version tag (e.g., v1.2.3)
    pullPolicy: Always  # Use Always when using latest tag
  service:
    name: profile-service
  configmaps:
    virtual_server_enabled: "true"
  secrets:
    db_user: admin
    db_password: password
    db_host: localhost
    db_port: "5432"
    db_name: profile_db
  resources:
    requests:
      memory: "128Mi"
      cpu: "200m"
    limits:
      memory: "256Mi"
      cpu: "400m"
  healthCheck:
    enabled: false 
  securityContext:
    enabled: false

notificationJob:
  enabled: true
  name: notification-job
  namespace: app
  schedule: "*/5 * * * *"  # ทุก 5 นาที (สำหรับ testing)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  startingDeadlineSeconds: 300
  activeDeadlineSeconds: 3600
  backoffLimit: 3
  restartPolicy: OnFailure
  image:
    repository: nginx
    tag: latest
    pullPolicy: Always
  command: []
  args: []
  configmaps:
    virtual_server_enabled: "true"
  secrets:
    db_user: admin
    db_password: password
    db_host: localhost
    db_port: "5432"
    db_name: notification_db
  env: []

# Keycloak service configuration
keycloak:
  enabled: true
  namespace: keycloak
  replicas: 2  # Production: use multiple replicas for HA
  image:
    repository: docker.io/library/keycloak
    tag: 26.4.7-postgres  # หรือใช้ latest
    pullPolicy: Never  # Use Never for local images loaded into k3s
    # Note: Keycloak optimized build includes PostgreSQL driver by default
    # Image must be loaded into k3s: make load-keycloak
  service:
    name: keycloak-service
    type: ClusterIP
    port: 8080
    targetPort: 8080
  configmaps:
    # Keycloak configuration
    proxy: edge  # edge works best with Traefik Ingress
    hostname_strict: "false"
    hostname_strict_https: "false"
  secrets:
    # Database configuration - ใช้ข้อมูลที่คุณให้มา
    db_vendor: postgres
    db_user: appuser
    db_password: mypassword
    db_host: 192.168.1.126
    db_port: "5432"
    db_name: keycloak  # ต้องสร้าง database นี้ใน PostgreSQL ก่อน
    # Admin credentials
    admin_user: admin
    admin_password: admin  # ⚠️ เปลี่ยนเป็นรหัสผ่านที่ปลอดภัยสำหรับ production!
  # Keycloak specific environment variables
  # Note: KC_HEALTH_ENABLED, KC_METRICS_ENABLED, KC_HTTP_RELATIVE_PATH are build-time options
  # They are set in Dockerfile.kc during build
  env:
    - name: KC_HTTP_ENABLED
      value: "true"
    - name: KC_HOSTNAME_STRICT
      value: "false"  # Set to "true" for production with proper hostname
    - name: KC_HOSTNAME_STRICT_HTTPS
      value: "false"  # Set to "true" for production with HTTPS
    # Keycloak configuration for access through Ingress
    - name: KC_HOSTNAME
      value: "keycloak.local"
    - name: KC_PROXY
      value: "edge"
    - name: KC_PROXY_HEADERS
      value: "xforwarded"
    - name: KC_DB_POOL_INITIAL_SIZE
      value: "5"
    - name: KC_DB_POOL_MIN_SIZE
      value: "5"
    - name: KC_DB_POOL_MAX_SIZE
      value: "20"
    # Production settings
    - name: KC_LOG_LEVEL
      value: "INFO"  # INFO for production, DEBUG for troubleshooting
    - name: KC_CACHE
      value: "ispn"  # Use Infinispan for distributed caching (required for multiple replicas)
    - name: KC_CACHE_STACK
      value: "tcp"  # TCP stack for cache communication
    # KC_PROXY is set from ConfigMap, not from env to avoid duplication
  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"
  args:
    - start
    - --optimized
    # Note: Keycloak 26.4.7 optimized build includes PostgreSQL driver by default
  # Ingress configuration for Keycloak (separate ingress in keycloak namespace)
  ingress:
    enabled: true
    className: traefik
    host: keycloak.local
    path: /
    pathType: Prefix
    annotations:
      traefik.ingress.kubernetes.io/rule-type: PathPrefix
      traefik.ingress.kubernetes.io/redirect-to-https: "false"
      traefik.ingress.kubernetes.io/forward-auth-headers: "true"
      traefik.ingress.kubernetes.io/entrypoints: "web"
    middlewares: []
    tls:
      enabled: false
      secretName: keycloak-tls-secret
  # Health checks
  healthCheck:
    enabled: true
    livenessProbe:
      httpGet:
        path: /health/live
        port: 8080
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1
    readinessProbe:
      httpGet:
        path: /health/ready
        port: 8080
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1
  # Security context
  securityContext:
    enabled: true
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL